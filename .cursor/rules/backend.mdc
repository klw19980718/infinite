---
alwaysApply: true
---

## Supabase ç”¨æ³•
- ä»…é€šè¿‡ `@/lib/supabase` æš´éœ²çš„ helper ä½¿ç”¨ï¼š
  - `getSupabaseClient()` - ç”¨äº Client ç»„ä»¶ï¼ˆæµè§ˆå™¨ç¯å¢ƒï¼‰
  - `getServerSupabase()` - ç”¨äºæœåŠ¡ç«¯ï¼Œéœ€è¦ SERVICE_ROLE_KEY çš„æ“ä½œï¼ˆå¦‚ webhooksï¼‰
- æœåŠ¡ç«¯è®¤è¯ï¼ˆä» cookie è¯»å– sessionï¼‰ï¼š
  - `@/lib/supabase/server.server.ts` - æœåŠ¡ç«¯ä¸“ç”¨æ–‡ä»¶ï¼ˆ`.server.ts` åç¼€ç¡®ä¿ä¸ä¼šè¢«æ‰“åŒ…åˆ°å®¢æˆ·ç«¯ï¼‰
    - `createServerSupabaseClient()` - ç”¨äº Server Components å’Œ Server Actions
    - `createServerSupabaseClientForRouteHandler(request, response)` - ç”¨äº API Route Handlers
- æ‰€æœ‰æŸ¥è¯¢é»˜è®¤ **RLS å¼€å¯**ï¼›æœåŠ¡ç«¯éœ€è¦æ›´é«˜æƒé™æ—¶ï¼Œä½¿ç”¨**æœåŠ¡ç«¯å¯†é’¥**äº Route Handlerï¼ˆä¸å¯åœ¨å®¢æˆ·ç«¯æš´éœ²ï¼‰ã€‚

## API & Route Handlers
- API è·¯ç”±æ”¾ /app/api/**ï¼Œé»˜è®¤ Edge ä»…å½“æ—  Node ä¾èµ–ã€‚
- æ ¡éªŒï¼šZodï¼ˆæˆ–æœ€å°æ‰‹å†™æ ¡éªŒï¼‰ï¼›è¿”å›æ˜ç¡®çš„é”™è¯¯ç»“æ„ `{ ok:false, code, message }`ã€‚
- ç¦æ­¢åœ¨ API ä¸­åš SSR-only ä»»åŠ¡ä¸é‡é‡çº§é˜»å¡ï¼ˆäº¤ç»™é˜Ÿåˆ—/edge/cronï¼‰ã€‚
âš ï¸ **é‡è¦ç»´æŠ¤æé†’**ï¼š
- ğŸ”´ å½“é¡¹ç›®app/apiæœ‰ä»»ä½•æ”¹åŠ¨æ—¶ï¼Œå¿…é¡»ç«‹å³æ›´æ–°æ­¤æ–‡ä»¶
- ğŸ”´ ä¿æŒæ­¤å†…å®¹ä¸ºæœ€æ–°

### ğŸš€ Creem æ”¯ä»˜é›†æˆ

#### POST `/api/creem/checkout`
**åŠŸèƒ½**: åˆ›å»º Creem æ”¯ä»˜ä¼šè¯ï¼Œè¿”å›æ”¯ä»˜é¡µé¢ URL  
**è¯·æ±‚ä½“**:
```typescript
{
  planId: 'pro' | 'ultimate' | 'enterprise'
}
```
**è¿”å›**:
```typescript
{
  ok: true,
  checkout_url: string,
  checkout_id: string,
  request_id: string
}
// é”™è¯¯æƒ…å†µï¼š
{
  ok: false,
  code: 'INVALID_PLAN' | 'UNAUTHORIZED' | 'PRODUCT_NOT_FOUND' | 'CHECKOUT_ERROR' | 'INTERNAL_ERROR',
  message: string
}
```
**æµç¨‹**:
1. ä» cookie éªŒè¯ç”¨æˆ·èº«ä»½ï¼ˆä½¿ç”¨ `createServerSupabaseClientForRouteHandler`ï¼‰
2. éªŒè¯ planId å¹¶æ˜ å°„åˆ° Creem äº§å“ ID
3. ç”Ÿæˆå”¯ä¸€ request_idï¼ˆåŸºäºç”¨æˆ·IDï¼‰
4. è°ƒç”¨ Creem API åˆ›å»º checkout ä¼šè¯ï¼ˆmetadata ä¸­è‡ªåŠ¨åŒ…å«æœåŠ¡ç«¯è·å–çš„ user.id å’Œ user.emailï¼‰
5. è¿”å›æ”¯ä»˜é¡µé¢ URLï¼Œå‰ç«¯é‡å®šå‘

**è®¤è¯æ–¹å¼**: ä½¿ç”¨ cookie-based è®¤è¯ï¼Œä» `NextRequest` è¯»å–ç”¨æˆ· session

**ç¯å¢ƒå˜é‡**: `CREEM_API_KEY`, `CREEM_PRODUCT_PRO_ID`, `CREEM_PRODUCT_ULTIMATE_ID`, `CREEM_PRODUCT_ENTERPRISE_ID`, `CREEM_API_URL` (å¯é€‰), `NEXT_PUBLIC_SITE_URL`

#### POST `/api/creem/webhook`
**åŠŸèƒ½**: å¤„ç† Creem æ”¯ä»˜å®Œæˆ webhook äº‹ä»¶ï¼Œæ›´æ–°ç”¨æˆ·ç§¯åˆ†  
**è¯·æ±‚å¤´**: 
- `Creem-Signature` æˆ– `x-creem-signature` (HMAC ç­¾å)
- `Creem-Timestamp` æˆ– `x-creem-timestamp` (å¯é€‰ï¼Œç”¨äºç­¾åéªŒè¯)
**è¯·æ±‚ä½“**: Creem webhook äº‹ä»¶ JSON
```typescript
{
  id: string,              // äº‹ä»¶å”¯ä¸€IDï¼ˆç”¨äºå¹‚ç­‰æ€§ï¼‰
  eventType: 'checkout.completed' | 'checkout.session.completed',
  object: {
    id: string,            // checkout.id
    request_id: string,
    metadata: {
      user_id: string,    // UUID
      user_email: string,
      plan_id: 'pro' | 'ultimate' | 'enterprise'
    },
    order?: {
      id: string,
      product: string,    // Creem äº§å“ ID
      amount: number,
      currency: string
    },
    product?: {
      id: string          // Creem äº§å“ ID
    }
  }
}
```
**è¿”å›**: 
```typescript
{ received: true }  // æˆåŠŸæˆ–é‡å¤è¯·æ±‚
// é”™è¯¯æƒ…å†µï¼š
{
  ok: false,
  message: string
}
```
**æµç¨‹**:
1. éªŒè¯ HMAC ç­¾åï¼ˆç”Ÿäº§ç¯å¢ƒå¼ºåˆ¶ï¼Œå¼€å‘ç¯å¢ƒå¯é€‰ï¼‰
2. å¹‚ç­‰æ€§æ£€æŸ¥ï¼ˆé€šè¿‡ `event.id` å’Œ `checkout.id`ï¼‰
3. ä» metadata æå– user_id å’Œ plan_id
4. æ ¹æ® plan_id è®¡ç®—ç§¯åˆ†ï¼ˆpro: 400, ultimate: 800, enterprise: 1800ï¼‰
5. è°ƒç”¨ `add_user_credits` RPC å‡½æ•°å¢åŠ ç§¯åˆ†
6. æ˜ å°„ Creem äº§å“ ID åˆ°æœ¬åœ° products è¡¨ UUID
7. åˆ›å»º orders è®°å½•ï¼ˆstatus='paid'ï¼‰
8. æ›´æ–° payments è®°å½•ï¼ˆå…³è” order_id å’Œå®Œæ•´ payloadï¼‰

**å¹‚ç­‰æ€§ç­–ç•¥**:
- ä¸»é”ï¼š`payments.unique_key = event.id`ï¼Œå†²çªåˆ™ç›´æ¥è¿”å› 200
- æ¬¡é”ï¼š`orders.creem_session_id = checkout.id`ï¼Œå·²å­˜åœ¨åˆ™è·³è¿‡

**ç§¯åˆ†æ˜ å°„**: `{ pro: 400, ultimate: 800, enterprise: 1800 }`

**ç¯å¢ƒå˜é‡**: `CREEM_WEBHOOK_SECRET`

### ğŸ¥ WaveSpeedAI è§†é¢‘ç”Ÿæˆé›†æˆ

#### POST `/api/video/image-to-video`
**åŠŸèƒ½**: æäº¤å›¾ç‰‡è½¬è§†é¢‘ä»»åŠ¡ï¼Œä»å›¾ç‰‡å’ŒéŸ³é¢‘ç”Ÿæˆè¯´è¯è§†é¢‘  
**è¯·æ±‚æ–¹å¼**: `multipart/form-data`  
**è¯·æ±‚å‚æ•°**:
```typescript
{
  image: File (å¿…éœ€) - è¾“å…¥å›¾ç‰‡æ–‡ä»¶
  audio: File (å¿…éœ€) - è¾“å…¥éŸ³é¢‘æ–‡ä»¶
  resolution: 'fast' | '480p' | '720p' (å¯é€‰, é»˜è®¤: 'fast')
  prompt: string (å¯é€‰) - æç¤ºè¯
  seed: number (å¯é€‰, é»˜è®¤: -1) - éšæœºç§å­
  mask_image: File (å¯é€‰) - æ©ç å›¾ç‰‡ï¼ŒæŒ‡å®šè¦åŠ¨ç”»åŒ–çš„åŒºåŸŸ
}
```
**è¿”å›**:
```typescript
{
  ok: true,
  task_id: string (uuid),
  wavespeed_task_id: string,
  status: 'processing'
}
// é”™è¯¯æƒ…å†µï¼š
{
  ok: false,
  code: 'UNAUTHORIZED' | 'MISSING_FILES' | 'INVALID_RESOLUTION' | 'TASK_CREATION_FAILED' | 'WAVESPEED_ERROR' | 'INTERNAL_ERROR',
  message: string
}
```
**æµç¨‹**:
1. ä» cookie éªŒè¯ç”¨æˆ·èº«ä»½ï¼ˆä½¿ç”¨ `createServerSupabaseClientForRouteHandler`ï¼‰
2. éªŒè¯å¿…éœ€æ–‡ä»¶ï¼ˆimage, audioï¼‰
3. **å…ˆæ£€æŸ¥ç”¨æˆ·ç§¯åˆ†æ˜¯å¦è¶³å¤Ÿï¼ˆåœ¨æ–‡ä»¶ä¸Šä¼ å‰ï¼‰**
4. ä¸Šä¼ æ–‡ä»¶åˆ° WaveSpeedAI åª’ä½“å­˜å‚¨
5. è°ƒç”¨ `create_video_task` RPC å‡½æ•°åˆ›å»ºä»»åŠ¡å¹¶æ‰£é™¤ç§¯åˆ†
6. æ„å»º Webhook URLï¼ˆåŒ…å« task_idï¼‰
7. **æ ¹æ® resolution é€‰æ‹© API æ¥å£**ï¼š
   - `fast`: è°ƒç”¨ `/api/v3/wavespeed-ai/infinitetalk-fast`ï¼ˆä¸ä¼  resolution å‚æ•°ï¼‰
   - `480p` æˆ– `720p`: è°ƒç”¨ `/api/v3/wavespeed-ai/infinitetalk`ï¼ˆä¼ é€’ resolution å‚æ•°ï¼‰
8. æäº¤ä»»åŠ¡åˆ° WaveSpeedAI APIï¼ˆæºå¸¦ Webhook URLï¼‰
9. æ›´æ–°ä»»åŠ¡çŠ¶æ€ä¸º 'processing'
10. è¿”å›ä»»åŠ¡ ID

**è®¤è¯æ–¹å¼**: ä½¿ç”¨ cookie-based è®¤è¯ï¼Œä» `NextRequest` è¯»å–ç”¨æˆ· session

**ç§¯åˆ†æ‰£é™¤**: 
- **fast**: 0.5 ç§¯åˆ†/ç§’ï¼ˆå‘ä¸Šå–æ•´ï¼‰ï¼Œæœ€å° 3 ç§¯åˆ†
- **480p**: 1 ç§¯åˆ†/ç§’ï¼Œæœ€å° 5 ç§¯åˆ†
- **720p**: 2 ç§¯åˆ†/ç§’ï¼Œæœ€å° 10 ç§¯åˆ†
- æœ€å¤§: 600 ç§’ï¼ˆfast=300ç§¯åˆ†ï¼Œ480p=600ç§¯åˆ†ï¼Œ720p=1200ç§¯åˆ†ï¼‰

**ç¯å¢ƒå˜é‡**: `WAVESPEED_KEY`, `WAVESPEED_WEBHOOK_SECRET`, `NGROK_DEV_URL` (å¼€å‘ç¯å¢ƒ)

#### POST `/api/video/video-to-video`
**åŠŸèƒ½**: æäº¤è§†é¢‘è½¬è§†é¢‘ä»»åŠ¡ï¼Œä»è§†é¢‘å’ŒéŸ³é¢‘ç”Ÿæˆè¯´è¯è§†é¢‘  
**è¯·æ±‚æ–¹å¼**: `multipart/form-data`  
**è¯·æ±‚å‚æ•°**:
```typescript
{
  video: File (å¿…éœ€) - è¾“å…¥è§†é¢‘æ–‡ä»¶
  audio: File (å¿…éœ€) - è¾“å…¥éŸ³é¢‘æ–‡ä»¶
  resolution: 'fast' | '480p' | '720p' (å¯é€‰, é»˜è®¤: 'fast')
  prompt: string (å¯é€‰) - æç¤ºè¯
  seed: number (å¯é€‰, é»˜è®¤: -1) - éšæœºç§å­
  mask_image: File (å¯é€‰) - æ©ç å›¾ç‰‡ï¼ŒæŒ‡å®šè¦åŠ¨ç”»åŒ–çš„åŒºåŸŸ
}
```
**è¿”å›**: åŒ image-to-video æ¥å£
**æµç¨‹**: 
1. åŒ image-to-video æ¥å£ï¼ˆä½¿ç”¨ video æ–‡ä»¶è€Œé imageï¼‰
2. **æ ¹æ® resolution é€‰æ‹© API æ¥å£**ï¼š
   - `fast`: è°ƒç”¨ `/api/v3/wavespeed-ai/infinitetalk-fast/video-to-video`ï¼ˆä¸ä¼  resolution å‚æ•°ï¼‰
   - `480p` æˆ– `720p`: è°ƒç”¨ `/api/v3/wavespeed-ai/infinitetalk/video-to-video`ï¼ˆä¼ é€’ resolution å‚æ•°ï¼‰
**è®¤è¯æ–¹å¼**: ä½¿ç”¨ cookie-based è®¤è¯ï¼Œä» `NextRequest` è¯»å–ç”¨æˆ· session
**ç§¯åˆ†æ‰£é™¤**: åŒ image-to-video æ¥å£

#### POST `/api/video/webhook`
**åŠŸèƒ½**: æ¥æ”¶ WaveSpeedAI ä»»åŠ¡å®Œæˆ/å¤±è´¥å›è°ƒï¼Œæ›´æ–°ä»»åŠ¡çŠ¶æ€
**è¯·æ±‚å¤´**:
- `webhook-signature` (HMAC ç­¾å)
- `webhook-id` (äº‹ä»¶ID)
- `webhook-timestamp` (æ—¶é—´æˆ³)
**è¯·æ±‚ä½“**: WaveSpeed Webhook JSON
```typescript
{
  id: string,
  status: 'completed' | 'failed',
  outputs: string[],
  error?: string
  // ...
}
```
**è¿”å›**: `200 OK`
**æµç¨‹**:
1. éªŒè¯ HMAC ç­¾åï¼ˆä½¿ç”¨ `WAVESPEED_WEBHOOK_SECRET`ï¼‰
2. å¹‚ç­‰æ€§æ£€æŸ¥ï¼ˆæŸ¥è¯¢ `webhook_events` è¡¨ï¼‰
3. æå– `task_id`ï¼ˆä» URL query å‚æ•°ï¼‰
4. è°ƒç”¨ `update_video_task` RPC æ›´æ–°ä»»åŠ¡çŠ¶æ€å’Œç»“æœ
5. å¦‚æœä»»åŠ¡å®Œæˆï¼Œè®¾ç½® `expires_at`ï¼ˆ7å¤©ä¿ç•™æœŸï¼‰
6. è®°å½• webhook äº‹ä»¶åˆ° `webhook_events` è¡¨

**ç¯å¢ƒå˜é‡**: `WAVESPEED_WEBHOOK_SECRET`

#### GET `/api/video/result`
**åŠŸèƒ½**: æŸ¥è¯¢è§†é¢‘ç”Ÿæˆä»»åŠ¡ç»“æœ  
**æŸ¥è¯¢å‚æ•°**:
```typescript
{
  task_id: string (uuid, å¿…éœ€) - ä»»åŠ¡ ID
}
```
**è¿”å›**:
```typescript
{
  ok: true,
  task_id: string,
  status: 'created' | 'processing' | 'completed' | 'failed',
  outputs: string[],  // å®Œæˆæ—¶åŒ…å«è§†é¢‘ URL æ•°ç»„
  error?: string     // å¤±è´¥æ—¶çš„é”™è¯¯ä¿¡æ¯
}
// é”™è¯¯æƒ…å†µï¼š
{
  ok: false,
  code: 'UNAUTHORIZED' | 'MISSING_TASK_ID' | 'TASK_NOT_FOUND' | 'WAVESPEED_ERROR' | 'INTERNAL_ERROR',
  message: string
}
```
**æµç¨‹**:
1. ä» cookie éªŒè¯ç”¨æˆ·èº«ä»½ï¼ˆä½¿ç”¨ `createServerSupabaseClientForRouteHandler`ï¼‰
2. éªŒè¯ä»»åŠ¡å½’å±ï¼ˆç”¨æˆ·åªèƒ½æŸ¥è¯¢è‡ªå·±çš„ä»»åŠ¡ï¼‰
3. ä» WaveSpeedAI API è·å–ä»»åŠ¡çŠ¶æ€
4. æ›´æ–°æœ¬åœ°ä»»åŠ¡çŠ¶æ€å’Œç»“æœ
5. **å¦‚æœä»»åŠ¡çŠ¶æ€ä¸º `completed`ï¼Œè‡ªåŠ¨è®¾ç½® `expires_at = created_at + 7å¤©`ï¼ˆç”¨äºä½œå“7å¤©ä¿ç•™æœŸï¼‰**
6. è¿”å›ä»»åŠ¡çŠ¶æ€å’Œç»“æœ

**è®¤è¯æ–¹å¼**: ä½¿ç”¨ cookie-based è®¤è¯ï¼Œä» `NextRequest` è¯»å–ç”¨æˆ· session

**ç¯å¢ƒå˜é‡**: `WAVESPEED_KEY`

#### POST `/api/speech/text-to-speech`
**åŠŸèƒ½**: ä½¿ç”¨ MiniMax Speech 02 Hd å°†æ–‡æœ¬è½¬æ¢ä¸ºè¯­éŸ³ï¼ˆé€šè¿‡ WaveSpeedAI APIï¼‰  
**è¯·æ±‚æ–¹å¼**: `application/json`  
**è¯·æ±‚ä½“**:
```typescript
{
  text: string (å¿…éœ€) - è¦è½¬æ¢ä¸ºè¯­éŸ³çš„æ–‡æœ¬ï¼ˆæœ€å¤§ 50,000 å­—ç¬¦ï¼‰
  voice_id?: string (å¯é€‰) - è¯­éŸ³ ID
  speed?: number (å¯é€‰, é»˜è®¤: 1.0) - è¯­éŸ³é€Ÿåº¦ï¼ŒèŒƒå›´: 0.5-2.0
  vol?: number (å¯é€‰, é»˜è®¤: 1.0) - è¯­éŸ³éŸ³é‡ï¼ŒèŒƒå›´: 0-10
  pitch?: number (å¯é€‰, é»˜è®¤: 0) - è¯­éŸ³éŸ³è°ƒï¼ŒèŒƒå›´: -12 åˆ° 12
  emotion?: "happy" | "sad" | "angry" | "fearful" | "disgusted" | "surprised" | "calm" | "fluent" (å¯é€‰) - æƒ…æ„Ÿ
  language_boost?: string (å¯é€‰) - è¯­è¨€å¢å¼ºï¼Œä¾‹å¦‚: "auto", "Chinese", "English"
  audio_setting?: {
    audio_sample_rate?: 8000 | 16000 | 22050 | 24000 | 32000 | 44100 (å¯é€‰, é»˜è®¤: 32000)
    bitrate?: 32000 | 64000 | 128000 | 256000 (å¯é€‰, é»˜è®¤: 128000, ä»… mp3)
    format?: "mp3" | "pcm" | "flac" (å¯é€‰, é»˜è®¤: "mp3")
    channel?: number (å¯é€‰, é»˜è®¤: 1)
  }
  wait?: boolean (å¯é€‰, é»˜è®¤: false) - æ˜¯å¦ç­‰å¾…ç»“æœç”Ÿæˆå®Œæˆå†è¿”å›
}
```
**è¿”å›**:
```typescript
{
  ok: true,
  task_id: string,
  status: string,
  outputs?: string[],  // ä»…åœ¨ wait=true æ—¶å­˜åœ¨
  urls: {
    get: string  // è·å–ä»»åŠ¡ç»“æœçš„ URL
  },
  tts_usage: {
    free_characters_used: number,  // æœ¬æ¬¡ä½¿ç”¨çš„å…è´¹å­—ç¬¦æ•°
    paid_characters: number,       // æœ¬æ¬¡éœ€è¦ä»˜è´¹çš„å­—ç¬¦æ•°
    credits_deducted: number,      // æœ¬æ¬¡æ‰£é™¤çš„ç§¯åˆ†æ•°
    remaining_free: number,        // ä»Šæ—¥å‰©ä½™å…è´¹å­—ç¬¦æ•°
    total_used_today: number       // ä»Šæ—¥æ€»ä½¿ç”¨å­—ç¬¦æ•°
  }
}
// é”™è¯¯æƒ…å†µï¼š
{
  ok: false,
  code: 'UNAUTHORIZED' | 'MISSING_TEXT' | 'TEXT_TOO_LONG' | 'INVALID_SPEED' | 'INVALID_VOLUME' | 'INVALID_PITCH' | 'INVALID_EMOTION' | 'INSUFFICIENT_CREDITS' | 'CREDIT_DEDUCTION_ERROR' | 'WAVESPEED_ERROR' | 'INTERNAL_ERROR',
  message: string,
  required_credits?: number,  // å½“ code='INSUFFICIENT_CREDITS' æ—¶å­˜åœ¨
  available_credits?: number  // å½“ code='INSUFFICIENT_CREDITS' æ—¶å­˜åœ¨
}
```
**æµç¨‹**:
1. ä» cookie éªŒè¯ç”¨æˆ·èº«ä»½ï¼ˆä½¿ç”¨ `createServerSupabaseClientForRouteHandler`ï¼‰
2. éªŒè¯å¿…éœ€å­—æ®µï¼ˆtextï¼‰
3. éªŒè¯å¯é€‰å‚æ•°èŒƒå›´ï¼ˆspeed, vol, pitch, emotionï¼‰
4. **è°ƒç”¨ `deduct_tts_credits` RPC å‡½æ•°æ‰£é™¤ç§¯åˆ†**ï¼š
   - æ¯æ—¥å…è´¹é¢åº¦ï¼š3,000 å­—ç¬¦
   - è¶…å‡ºåï¼šæ¯ 1,000 å­—ç¬¦æ‰£ 2 ç§¯åˆ†
   - å¦‚æœç§¯åˆ†ä¸è¶³ï¼Œè¿”å› 402 é”™è¯¯
5. è°ƒç”¨ WaveSpeedAI API æäº¤æ–‡æœ¬è½¬è¯­éŸ³ä»»åŠ¡ï¼ˆæ¨¡å‹: minimax-speech-02-hdï¼‰
6. è¿”å›ä»»åŠ¡ IDã€çŠ¶æ€å’Œä½¿ç”¨æƒ…å†µ

**è®¤è¯æ–¹å¼**: ä½¿ç”¨ cookie-based è®¤è¯ï¼Œä» `NextRequest` è¯»å–ç”¨æˆ· session

**ç§¯åˆ†æ‰£é™¤è§„åˆ™**:
- æ¯æ—¥å…è´¹é¢åº¦ï¼š3,000 å­—ç¬¦ï¼ˆUTC æ—¶é—´æ¯å¤©é‡ç½®ï¼‰
- è¶…å‡ºå…è´¹é¢åº¦ï¼šæ¯ 1,000 å­—ç¬¦æ‰£ 2 ç§¯åˆ†ï¼ˆå‘ä¸Šå–æ•´ï¼‰
- ç§¯åˆ†ä¸è¶³æ—¶è¿”å› 402 Payment Required é”™è¯¯

**ç¯å¢ƒå˜é‡**: `WAVESPEED_KEY`

**å‚è€ƒæ–‡æ¡£**: https://wavespeed.ai/docs/docs-api/minimax/minimax-speech-02-hd

#### GET `/api/speech/usage`
**åŠŸèƒ½**: è·å–ç”¨æˆ·å½“å‰çš„ TTS ä½¿ç”¨æƒ…å†µï¼ˆå…è´¹é¢åº¦ï¼‰  
**è¯·æ±‚æ–¹å¼**: `GET`  
**è¿”å›**:
```typescript
{
  ok: true,
  usage: {
    characters_used: number,      // ä»Šæ—¥å·²ä½¿ç”¨çš„å­—ç¬¦æ•°
    remaining_free: number,        // ä»Šæ—¥å‰©ä½™å…è´¹å­—ç¬¦æ•°
    daily_limit: number            // æ¯æ—¥å…è´¹é™é¢ï¼ˆ3000å­—ç¬¦ï¼‰
  }
}
// é”™è¯¯æƒ…å†µï¼š
{
  ok: false,
  code: 'UNAUTHORIZED' | 'USAGE_FETCH_ERROR' | 'INTERNAL_ERROR',
  message: string
}
```
**æµç¨‹**:
1. ä» cookie éªŒè¯ç”¨æˆ·èº«ä»½ï¼ˆä½¿ç”¨ `createServerSupabaseClientForRouteHandler`ï¼‰
2. æŸ¥è¯¢ `tts_usage` è¡¨è·å–ä»Šæ—¥ä½¿ç”¨é‡
3. è®¡ç®—å‰©ä½™å…è´¹é¢åº¦ï¼ˆæ¯æ—¥ 3,000 å­—ç¬¦ï¼‰
4. è¿”å›ä½¿ç”¨æƒ…å†µ

**è®¤è¯æ–¹å¼**: ä½¿ç”¨ cookie-based è®¤è¯ï¼Œä» `NextRequest` è¯»å–ç”¨æˆ· session

#### GET `/api/proxy-file`
**åŠŸèƒ½**: ä½œä¸ºå—é™çš„æ–‡ä»¶ä»£ç†ï¼Œè§£å†³ä» `cdn.infinitetalkai.org` åŠ è½½å›¾ç‰‡/éŸ³é¢‘æ—¶çš„ CORS é—®é¢˜  
**è¯·æ±‚æ–¹å¼**: `GET`  
**æŸ¥è¯¢å‚æ•°**:
```typescript
{
  url: string  // å¿…éœ€ï¼Œè¦ä»£ç†çš„å®Œæ•´æ–‡ä»¶ URLï¼Œä»…æ”¯æŒ https://cdn.infinitetalkai.org åŸŸå
}
```
**è¿”å›**: é€ä¼ ä¸Šæ¸¸çš„äºŒè¿›åˆ¶å“åº”ï¼ˆå›¾ç‰‡æˆ–éŸ³é¢‘æµï¼‰ï¼Œå¸¦å…³é”®å¤´éƒ¨ï¼š
`content-type`, `content-length`, `accept-ranges`, `content-range`, `cache-control`, `etag`, `last-modified`  
é”™è¯¯æƒ…å†µï¼ˆJSONï¼‰ï¼š
```typescript
{
  ok: false,
  code: 'MISSING_URL' | 'INVALID_URL' | 'UNSUPPORTED_PROTOCOL' | 'HOST_NOT_ALLOWED',
  message: string
}
```
**æµç¨‹**:
1. ä» query ä¸­è¯»å– `url` å‚æ•°
2. æ ¡éªŒ URL åè®®ä¸º `http/https`
3. æ ¡éªŒ `hostname === 'cdn.infinitetalkai.org'`ï¼Œå¦åˆ™æ‹’ç»ï¼ˆé˜²æ­¢å˜æˆé€šç”¨ä»£ç†ï¼‰
4. å°†è¯·æ±‚è½¬å‘åˆ°ä¸Šæ¸¸ CDNï¼Œå¹¶é€ä¼ å…³é”®å“åº”å¤´ä¸å“åº”ä½“
5. ä¸æ·»åŠ  CORS å¤´ï¼Œç”±äºåŒæºï¼ˆ`/api`ï¼‰ï¼Œå‰ç«¯å¯ç›´æ¥ `fetch` è·å– blob

**è®¤è¯æ–¹å¼**: æ— ï¼ˆä»…é™ä»£ç†å›ºå®šç™½åå•åŸŸåï¼Œå†…éƒ¨ä½¿ç”¨ï¼‰

#### DELETE `/api/video/delete`
**åŠŸèƒ½**: åˆ é™¤ç”¨æˆ·è§†é¢‘ç”Ÿæˆä»»åŠ¡ï¼ˆä½œå“ï¼‰  
**æŸ¥è¯¢å‚æ•°**:
```typescript
{
  task_id: string (uuid, å¿…éœ€) - ä»»åŠ¡ ID
}
```
**è¿”å›**:
```typescript
{
  ok: true,
  message: "Task deleted successfully"
}
// é”™è¯¯æƒ…å†µï¼š
{
  ok: false,
  code: 'UNAUTHORIZED' | 'MISSING_TASK_ID' | 'TASK_NOT_FOUND' | 'DELETE_ERROR' | 'INTERNAL_ERROR',
  message: string
}
```
**æµç¨‹**:
1. ä» cookie éªŒè¯ç”¨æˆ·èº«ä»½ï¼ˆä½¿ç”¨ `createServerSupabaseClientForRouteHandler`ï¼‰
2. éªŒè¯ä»»åŠ¡å½’å±ï¼ˆç”¨æˆ·åªèƒ½åˆ é™¤è‡ªå·±çš„ä»»åŠ¡ï¼Œä½¿ç”¨ cookie-based å®¢æˆ·ç«¯é€šè¿‡ RLS æ£€æŸ¥ï¼‰
3. **ä½¿ç”¨æœåŠ¡ç«¯å¯†é’¥å®¢æˆ·ç«¯ï¼ˆ`getServerSupabase()`ï¼‰æ‰§è¡Œåˆ é™¤æ“ä½œï¼Œç»•è¿‡ RLS é™åˆ¶**
4. éªŒè¯åˆ é™¤ç»“æœï¼Œç¡®ä¿åˆ é™¤æˆåŠŸ
5. è¿”å›åˆ é™¤æˆåŠŸä¿¡æ¯

**è®¤è¯æ–¹å¼**: ä½¿ç”¨ cookie-based è®¤è¯ï¼Œä» `NextRequest` è¯»å–ç”¨æˆ· session

**å®‰å…¨**: 
- åŒé‡éªŒè¯ï¼ˆå…ˆç”¨ cookie-based å®¢æˆ·ç«¯éªŒè¯ä»»åŠ¡å­˜åœ¨ä¸”å±äºå½“å‰ç”¨æˆ·ï¼‰
- ä½¿ç”¨æœåŠ¡ç«¯å¯†é’¥ç»•è¿‡ RLS æ‰§è¡Œåˆ é™¤ï¼ˆåœ¨å·²éªŒè¯æƒé™åï¼‰
- åˆ é™¤æ“ä½œä»åŒ…å« `user_id` æ¡ä»¶ï¼Œé˜²æ­¢è¯¯åˆ 

## å®‰å…¨
- ç¦æ­¢æŠŠ `SERVICE_ROLE` æ”¾åˆ°ä»»ä½•å®¢æˆ·ç«¯å¯è¾¾ä»£ç /ç¯å¢ƒå˜é‡ã€‚
- å¯¹å¤–è¿”å›æ•°æ®**æŒ‰éœ€**é€‰æ‹©å­—æ®µï¼›æ°¸è¿œä¸è¦ `select *` æš´éœ²æ•æ„Ÿåˆ—ã€‚
- é™æµï¼šå¦‚æœ‰å¤–éƒ¨å¯è°ƒç”¨æ¥å£ï¼Œè‡³å°‘æŒ‰ IP/ä¼šè¯åšç®€å•é™æµã€‚

## æ•°æ®åº“è¡¨ç»“æ„

âš ï¸ **é‡è¦ç»´æŠ¤æé†’**ï¼š
- ğŸ”´ å½“æ•°æ®åº“æœ‰ä»»ä½•æ”¹åŠ¨æ—¶ï¼Œå¿…é¡»ç«‹å³æ›´æ–°æ­¤æ–‡ä»¶
- ğŸ”´ ä¿æŒæ­¤è¡¨ç»“æ„ä¸å®é™…æ•°æ®åº“åŒæ­¥æ˜¯å¼ºåˆ¶è¦æ±‚
- ğŸ”´ æ–°å¢è¡¨ã€ä¿®æ”¹å­—æ®µã€æ·»åŠ çº¦æŸæ—¶ï¼Œæ·»åŠ ç›¸åº”çš„è¯´æ˜æ³¨é‡Š

### ğŸ“Š å½“å‰è¡¨ç»“æ„ (2025-01-27)

#### ğŸ‘¤ user_info è¡¨
```sql
- user_id (uuid, ä¸»é”®) â†’ å…³è” auth.users.id
- credits (bigint, é»˜è®¤: 0) â†’ ç”¨æˆ·ç§¯åˆ†
- created_at (timestamptz, é»˜è®¤: now())
- updated_at (timestamptz, é»˜è®¤: now())
```
**ç”¨é€”**: å­˜å‚¨ç”¨æˆ·ç§¯åˆ†ä¿¡æ¯
**RLS**: âœ… å¯ç”¨
**æ–°ç”¨æˆ·åˆå§‹åŒ–**: é€šè¿‡ `auth.users` è¡¨çš„è§¦å‘å™¨ `on_auth_user_created` è‡ªåŠ¨åˆå§‹åŒ–ï¼Œç”¨æˆ·æ³¨å†Œåç«‹å³è·å¾— 10 ç§¯åˆ†æ¬¢è¿å¥–åŠ±

#### ğŸ›ï¸ products è¡¨
```sql
- id (uuid, ä¸»é”®, é»˜è®¤: uuid_generate_v4())
- title (text) â†’ äº§å“æ ‡é¢˜
- credits (integer, çº¦æŸ: > 0) â†’ ç§¯åˆ†æ•°é‡
- price_usd (numeric, çº¦æŸ: >= 0) â†’ ç¾å…ƒä»·æ ¼
- creem_product_id (text, å”¯ä¸€) â†’ Creemæ”¯ä»˜äº§å“ID
- type (product_typeæšä¸¾, é»˜è®¤: 'one_time') â†’ äº§å“ç±»å‹
  - æšä¸¾å€¼: 'one_time', 'subscription'
- currency (text, é»˜è®¤: 'USD') â†’ è´§å¸
- active (boolean, é»˜è®¤: true) â†’ æ˜¯å¦æ¿€æ´»
- created_at (timestamptz, é»˜è®¤: now())
```
**ç”¨é€”**: å­˜å‚¨äº§å“/å¥—é¤ä¿¡æ¯
**RLS**: âœ… å¯ç”¨

#### ğŸ’° credit_ledger è¡¨
```sql
- id (uuid, ä¸»é”®, é»˜è®¤: uuid_generate_v4())
- user_id (uuid) â†’ å…³è” auth.users.id
- delta (bigint) â†’ ç§¯åˆ†å˜åŠ¨é‡ï¼ˆæ­£æ•°å¢åŠ ï¼Œè´Ÿæ•°å‡å°‘ï¼‰
- note (text, å¯ç©º) â†’ å˜åŠ¨è¯´æ˜
- task_id (uuid, å¯ç©º) â†’ å…³è” video_tasks.idï¼ˆè§†é¢‘ä»»åŠ¡æ‰£åˆ†ï¼‰
- created_at (timestamptz, é»˜è®¤: now())
```
**ç”¨é€”**: ç§¯åˆ†å˜åŠ¨è®°å½•ï¼ˆå®¡è®¡æ—¥å¿—ï¼‰
**RLS**: âœ… å¯ç”¨

#### ğŸ¥ video_tasks è¡¨
```sql
- id (uuid, ä¸»é”®, é»˜è®¤: uuid_generate_v4())
- user_id (uuid) â†’ å…³è” auth.users.id
- wavespeed_task_id (text, å”¯ä¸€) â†’ InfiniteTalk API ä»»åŠ¡ID
- status (task_statusæšä¸¾, é»˜è®¤: 'pending') â†’ ä»»åŠ¡çŠ¶æ€
  - æšä¸¾å€¼: 'pending', 'processing', 'completed', 'failed'
- resolution (text, çº¦æŸ: 'fast'|'480p'|'720p') â†’ è§†é¢‘åˆ†è¾¨ç‡/æ¨¡å¼
- credits_used (bigint, çº¦æŸ: > 0) â†’ æ‰£é™¤çš„ç§¯åˆ†æ•°
- video_duration_seconds (integer, å¯ç©º) â†’ ç”Ÿæˆçš„è§†é¢‘æ—¶é•¿ï¼ˆç§’ï¼‰
- input_image_url (text) â†’ è¾“å…¥å›¾ç‰‡URL
- input_audio_url (text) â†’ è¾“å…¥éŸ³é¢‘URL
- output_video_url (text, å¯ç©º) â†’ è¾“å‡ºè§†é¢‘URL
- prompt (text, å¯ç©º) â†’ ç”¨æˆ·æç¤ºè¯
- seed (integer, å¯ç©º) â†’ éšæœºç§å­
- error_message (text, å¯ç©º) â†’ é”™è¯¯ä¿¡æ¯
- api_response (jsonb, å¯ç©º) â†’ APIåŸå§‹å“åº”
- expires_at (timestamptz, å¯ç©º) â†’ è¿‡æœŸæ—¶é—´ï¼ˆä»»åŠ¡å®Œæˆæ—¶è‡ªåŠ¨è®¾ç½®ä¸º created_at + 7å¤©ï¼Œç”¨äºä½œå“ä¿ç•™æœŸï¼‰
- created_at (timestamptz, é»˜è®¤: now())
- updated_at (timestamptz, é»˜è®¤: now())
```
**ç”¨é€”**: å­˜å‚¨è§†é¢‘ç”Ÿæˆä»»åŠ¡ä¿¡æ¯ï¼ˆåŒ…å«ç”¨æˆ·ä½œå“ï¼‰
**RLS**: âœ… å¯ç”¨
**ä½œå“ä¿ç•™**: ä»»åŠ¡å®Œæˆæ—¶è‡ªåŠ¨è®¾ç½® `expires_at`ï¼Œ7å¤©åè¿‡æœŸï¼ˆæŸ¥è¯¢æ—¶è¿‡æ»¤è¿‡æœŸè®°å½•ï¼‰

#### ğŸ“ uploaded_files è¡¨
```sql
- id (uuid, ä¸»é”®, é»˜è®¤: uuid_generate_v4())
- user_id (uuid) â†’ å…³è” auth.users.id
- task_id (uuid, å¯ç©º) â†’ å…³è” video_tasks.idï¼ˆå¦‚æœç”¨äºä»»åŠ¡ï¼‰
- file_type (file_typeæšä¸¾) â†’ æ–‡ä»¶ç±»å‹
  - æšä¸¾å€¼: 'image', 'audio', 'video'
- storage_path (text) â†’ Supabase Storageè·¯å¾„
- storage_url (text) â†’ å¯å…¬å¼€è®¿é—®çš„URL
- file_size (bigint, çº¦æŸ: > 0) â†’ æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰
- mime_type (text) â†’ MIMEç±»å‹
- created_at (timestamptz, é»˜è®¤: now())
```
**ç”¨é€”**: å­˜å‚¨ç”¨æˆ·ä¸Šä¼ çš„æ–‡ä»¶å…ƒæ•°æ®
**RLS**: âœ… å¯ç”¨

#### ğŸ”„ webhook_events è¡¨
```sql
- id (uuid, ä¸»é”®, é»˜è®¤: uuid_generate_v4())
- webhook_id (text, å”¯ä¸€, éç©º) â†’ WaveSpeed Webhook ID
- task_id (uuid, å…³è” video_tasks.id)
- event_type (text) â†’ äº‹ä»¶ç±»å‹ (e.g. 'completed', 'failed')
- payload_json (jsonb) â†’ å®Œæ•´ payload
- created_at (timestamptz, é»˜è®¤: now())
```
**ç”¨é€”**: è®°å½• Webhook äº‹ä»¶ï¼Œç”¨äºå¹‚ç­‰æ€§æ£€æŸ¥å’Œå®¡è®¡
**RLS**: âŒ ä»…æœåŠ¡ç«¯ä½¿ç”¨ï¼ˆService Roleï¼‰

#### ğŸ“¦ orders è¡¨
```sql
- id (uuid, ä¸»é”®, é»˜è®¤: uuid_generate_v4())
- user_id (uuid) â†’ å…³è” auth.users.id
- product_id (uuid) â†’ å…³è” products.id
- units (integer, é»˜è®¤: 1, çº¦æŸ: > 0) â†’ è´­ä¹°æ•°é‡
- status (order_statusæšä¸¾, é»˜è®¤: 'pending') â†’ è®¢å•çŠ¶æ€
  - æšä¸¾å€¼: 'pending', 'paid', 'refunded', 'canceled'
- request_id (text) â†’ è¯·æ±‚ID
- creem_session_id (text, å¯ç©º) â†’ Creemä¼šè¯ID
- creem_order_id (text, å¯ç©º) â†’ Creemè®¢å•ID
- amount_total_cents (integer, å¯ç©º) â†’ æ€»é‡‘é¢ï¼ˆåˆ†ï¼‰
- currency (text, å¯ç©º, é»˜è®¤: 'USD') â†’ è´§å¸
- created_at (timestamptz, é»˜è®¤: now())
- paid_at (timestamptz, å¯ç©º) â†’ æ”¯ä»˜æ—¶é—´
```
**ç”¨é€”**: è®¢å•ç®¡ç†
**RLS**: âœ… å¯ç”¨

#### ğŸ’³ payments è¡¨
```sql
- id (uuid, ä¸»é”®, é»˜è®¤: uuid_generate_v4())
- order_id (uuid, å¯ç©º) â†’ å…³è” orders.id
- provider (text, é»˜è®¤: 'creem') â†’ æ”¯ä»˜æä¾›å•†
- event_type (text) â†’ äº‹ä»¶ç±»å‹
- unique_key (text) â†’ å”¯ä¸€æ ‡è¯†
- payload_json (jsonb) â†’ æ”¯ä»˜æ•°æ®ï¼ˆJSONæ ¼å¼ï¼‰
- created_at (timestamptz, é»˜è®¤: now())
```
**ç”¨é€”**: æ”¯ä»˜äº‹ä»¶è®°å½•
**RLS**: âœ… å¯ç”¨

#### ğŸ“ tts_usage è¡¨
```sql
- id (uuid, ä¸»é”®, é»˜è®¤: uuid_generate_v4())
- user_id (uuid) â†’ å…³è” auth.users.id
- usage_date (date, é»˜è®¤: CURRENT_DATE) â†’ ä½¿ç”¨æ—¥æœŸ
- characters_used (integer, é»˜è®¤: 0) â†’ å½“æ—¥ä½¿ç”¨çš„å­—ç¬¦æ•°
- created_at (timestamptz, é»˜è®¤: now())
- updated_at (timestamptz, é»˜è®¤: now())
- UNIQUE(user_id, usage_date) â†’ æ¯ä¸ªç”¨æˆ·æ¯å¤©ä¸€æ¡è®°å½•
```
**ç”¨é€”**: è®°å½•ç”¨æˆ·æ¯æ—¥ TTS å­—ç¬¦ä½¿ç”¨é‡ï¼ˆç”¨äºå…è´¹é¢åº¦è¿½è¸ªï¼‰
**RLS**: âœ… å¯ç”¨ï¼ˆç”¨æˆ·åªèƒ½æŸ¥çœ‹è‡ªå·±çš„ä½¿ç”¨è®°å½•ï¼‰

### ğŸ”— è¡¨å…³ç³»å›¾
```
auth.users (Supabase Auth)
    â†“
user_info (ç”¨æˆ·ç§¯åˆ†)
    â†“
credit_ledger (ç§¯åˆ†å˜åŠ¨è®°å½•) â†’ video_tasks (è§†é¢‘ä»»åŠ¡)
                                    â†“
                            uploaded_files (ä¸Šä¼ æ–‡ä»¶)

products (äº§å“è¡¨)
    â†“
orders (è®¢å•è¡¨) â†’ payments (æ”¯ä»˜è®°å½•)
```

### ğŸ“ˆ æ•°æ®ç»Ÿè®¡
- **æ€»è¡¨æ•°**: 9ä¸ª (æ–°å¢ tts_usage)
- **æœ‰æ•°æ®çš„è¡¨**: products (3è¡Œ)
- **ç©ºè¡¨**: user_info, credit_ledger, orders, payments, video_tasks, uploaded_files, webhook_events, tts_usage
- **RLSçŠ¶æ€**: video_tasks éœ€å¼€å¯ Realtime Publicationï¼Œä¸”å¿…é¡»æœ‰ SELECT policy å…è®¸ç”¨æˆ·è¯»å–è‡ªå·±çš„æ•°æ®ä»¥ä¾¿å‰ç«¯è®¢é˜…ã€‚

## è§¦å‘å™¨ä¸å‡½æ•°ï¼ˆå¿…é¡»ä¿æŒåŒæ­¥ç»´æŠ¤ï¼‰

### credit_ledger â‡’ user_info åŒæ­¥è§¦å‘å™¨
```sql
-- åç§°ï¼štrg_credit_ledger_sync  è¡¨ï¼špublic.credit_ledger  æ—¶æœºï¼šAFTER INSERT/UPDATE/DELETE
-- å‡½æ•°ï¼špublic.tg_sync_user_credits()
-- è¯­ä¹‰ï¼šä»…ä»¥ ledger ä¸ºå•ä¸€äº‹å®æ¥æºï¼›ä»»ä½•å¯¹ ledger çš„å¢åˆ æ”¹éƒ½ä¼šåŒæ­¥åˆ° user_info.credits
--      INSERT  â†’ user_info.credits += NEW.delta
--      UPDATE  â†’ user_info.credits = credits - OLD.delta + NEW.delta
--      DELETE  â†’ user_info.credits -= OLD.delta
```

### user_info æ›´æ–°è§¦å‘å™¨
```sql
-- åç§°ï¼štrg_user_info_touch  è¡¨ï¼špublic.user_info  æ—¶æœºï¼šBEFORE UPDATE
-- å‡½æ•°ï¼špublic.tg_user_info_touch_updated_at()
-- è¯­ä¹‰ï¼šå†™å…¥ NEW.updated_at = now()
```

### RPCï¼špublic.add_user_credits
```sql
-- å‚æ•°ï¼šp_user_id uuid, p_credits_to_add bigint, p_note text
-- æƒé™ï¼šSECURITY DEFINERï¼ˆä»…æœåŠ¡ç«¯è°ƒç”¨ï¼‰
-- è¡Œä¸ºï¼ˆå·²ä¿®è®¢ï¼Œé¿å…é‡å¤åŠ åˆ†ï¼‰ï¼š
--   1) ç¡®ä¿ user_info è¡Œå­˜åœ¨ï¼ˆä¸ä¿®æ”¹ creditsï¼‰
--   2) ä»…å‘ credit_ledger å†™å…¥ä¸€æ¡ +delta çš„è®°å½•
--      ä½™é¢å˜åŠ¨ç”±è§¦å‘å™¨ tg_sync_user_credits() è‡ªåŠ¨å®Œæˆ
```

### RPCï¼špublic.create_video_task
```sql
-- å‚æ•°ï¼šp_user_id uuid, p_resolution text, p_input_image_url text, p_input_audio_url text, 
--       p_audio_duration_seconds integer, p_prompt text, p_seed integer
-- æƒé™ï¼šSECURITY DEFINERï¼ˆä»…æœåŠ¡ç«¯è°ƒç”¨ï¼‰
-- è¡Œä¸ºï¼š
--   1) è®¡ç®—æ‰€éœ€ç§¯åˆ†ï¼š
--      - fast: 0.5ç§¯åˆ†/ç§’ï¼ˆå‘ä¸Šå–æ•´ï¼‰ï¼Œæœ€å°3ç§¯åˆ†
--      - 480p: 1ç§¯åˆ†/ç§’ï¼Œæœ€å°5ç§¯åˆ†
--      - 720p: 2ç§¯åˆ†/ç§’ï¼Œæœ€å°10ç§¯åˆ†
--      - æœ€å¤§æ—¶é•¿: 600ç§’
--   2) æ£€æŸ¥ç”¨æˆ·ç§¯åˆ†æ˜¯å¦è¶³å¤Ÿ
--   3) åˆ›å»ºä»»åŠ¡è®°å½•ï¼ˆstatus = 'pending'ï¼‰
--   4) æ‰£é™¤ç§¯åˆ†ï¼ˆå†™å…¥ credit_ledgerï¼Œå…³è” task_idï¼‰
--   5) è¿”å›ä»»åŠ¡ ID
```

### RPCï¼špublic.update_video_task
```sql
-- å‚æ•°ï¼šp_task_id uuid, p_status task_status, p_wavespeed_task_id text, 
--       p_output_video_url text, p_video_duration_seconds integer, 
--       p_error_message text, p_api_response jsonb
-- æƒé™ï¼šSECURITY DEFINERï¼ˆä»…æœåŠ¡ç«¯è°ƒç”¨ï¼‰
-- è¡Œä¸ºï¼šæ›´æ–°ä»»åŠ¡çŠ¶æ€ã€ç»“æœã€é”™è¯¯ä¿¡æ¯ç­‰
```

### video_tasks æ›´æ–°è§¦å‘å™¨
```sql
-- åç§°ï¼štrg_video_tasks_updated_at  è¡¨ï¼špublic.video_tasks  æ—¶æœºï¼šBEFORE UPDATE
-- å‡½æ•°ï¼špublic.tg_update_updated_at()
-- è¯­ä¹‰ï¼šå†™å…¥ NEW.updated_at = now()
```

### tts_usage æ›´æ–°è§¦å‘å™¨
```sql
-- åç§°ï¼štrg_tts_usage_updated_at  è¡¨ï¼špublic.tts_usage  æ—¶æœºï¼šBEFORE UPDATE
-- å‡½æ•°ï¼špublic.tg_tts_usage_touch_updated_at()
-- è¯­ä¹‰ï¼šå†™å…¥ NEW.updated_at = now()
```

### RPCï¼špublic.initialize_user_with_welcome_credits
```sql
-- å‚æ•°ï¼šp_user_id uuid
-- æƒé™ï¼šSECURITY DEFINERï¼ˆä»…æœåŠ¡ç«¯è°ƒç”¨ï¼‰
-- è¿”å›ï¼šjsonb
-- è¡Œä¸ºï¼š
--   1) æ£€æŸ¥ user_info æ˜¯å¦å·²å­˜åœ¨ï¼ˆå¹‚ç­‰æ€§æ£€æŸ¥ï¼‰
--   2) å¦‚æœå·²å­˜åœ¨ï¼Œç›´æ¥è¿”å›æˆåŠŸï¼ˆä¸é‡å¤èµ é€ï¼‰
--   3) å¦‚æœä¸å­˜åœ¨ï¼š
--      - åˆ›å»º user_info è®°å½•ï¼ˆcredits = 0ï¼‰
--      - é€šè¿‡ credit_ledger æ·»åŠ æ¬¢è¿ç§¯åˆ†ï¼ˆ10 ç§¯åˆ†ï¼‰
--      - è§¦å‘å™¨è‡ªåŠ¨åŒæ­¥åˆ° user_info.credits
--   4) è¿”å›åˆå§‹åŒ–ç»“æœï¼ˆsuccess, already_initialized, credits_addedï¼‰
-- è¿”å›æ ¼å¼ï¼š
--   {
--     success: boolean,
--     already_initialized: boolean,
--     credits_added?: integer (ä»…å½“ already_initialized=false æ—¶å­˜åœ¨),
--     message: string
--   }
-- ç”¨é€”ï¼šæ–°ç”¨æˆ·æ³¨å†Œæ—¶è‡ªåŠ¨åˆå§‹åŒ–å¹¶èµ é€ 10 ç§¯åˆ†æ¬¢è¿å¥–åŠ±
```

### auth.users è§¦å‘å™¨ï¼šè‡ªåŠ¨åˆå§‹åŒ–æ–°ç”¨æˆ·
```sql
-- åç§°ï¼šon_auth_user_created  è¡¨ï¼šauth.users  æ—¶æœºï¼šAFTER INSERT
-- å‡½æ•°ï¼špublic.handle_new_user()
-- è¯­ä¹‰ï¼šå½“ç”¨æˆ·é€šè¿‡ Supabase Auth æ³¨å†Œæ—¶ï¼Œè‡ªåŠ¨è°ƒç”¨ initialize_user_with_welcome_credits
--       ç¡®ä¿æ–°ç”¨æˆ·æ³¨å†Œåç«‹å³è·å¾— 10 ç§¯åˆ†æ¬¢è¿å¥–åŠ±
-- æµç¨‹ï¼š
--   1) ç”¨æˆ·é€šè¿‡ Supabase Auth æ³¨å†Œï¼ˆEmail OTP æˆ– Google OAuthï¼‰
--   2) auth.users è¡¨æ’å…¥æ–°è®°å½•
--   3) è§¦å‘å™¨è‡ªåŠ¨æ‰§è¡Œ handle_new_user()
--   4) è°ƒç”¨ initialize_user_with_welcome_credits åˆå§‹åŒ–ç”¨æˆ·å¹¶èµ é€ 10 ç§¯åˆ†
--   5) ç”¨æˆ·æ³¨å†Œå®Œæˆåå³å¯åœ¨ä¸ªäººä¸­å¿ƒçœ‹åˆ° 10 ç§¯åˆ†
```

### RPCï¼špublic.deduct_tts_credits
```sql
-- å‚æ•°ï¼šp_user_id uuid, p_characters integer
-- æƒé™ï¼šSECURITY DEFINERï¼ˆä»…æœåŠ¡ç«¯è°ƒç”¨ï¼‰
-- è¿”å›ï¼šjsonb
-- è¡Œä¸ºï¼š
--   1) æ£€æŸ¥ç”¨æˆ·ä»Šæ—¥ TTS ä½¿ç”¨é‡ï¼ˆä» tts_usage è¡¨ï¼‰
--   2) è®¡ç®—å…è´¹é¢åº¦å‰©ä½™ï¼ˆæ¯æ—¥ 3,000 å­—ç¬¦ï¼‰
--   3) å¦‚æœè¶…å‡ºå…è´¹é¢åº¦ï¼Œè®¡ç®—éœ€è¦æ‰£é™¤çš„ç§¯åˆ†ï¼ˆæ¯ 1,000 å­—ç¬¦ 2 ç§¯åˆ†ï¼Œå‘ä¸Šå–æ•´ï¼‰
--   4) æ£€æŸ¥ç”¨æˆ·ç§¯åˆ†æ˜¯å¦è¶³å¤Ÿ
--   5) æ‰£é™¤ç§¯åˆ†ï¼ˆå†™å…¥ credit_ledgerï¼Œnote åŒ…å«å­—ç¬¦æ•°ï¼‰
--   6) æ›´æ–° tts_usage è¡¨çš„ä½¿ç”¨é‡
--   7) è¿”å›ä½¿ç”¨æƒ…å†µï¼ˆå…è´¹å­—ç¬¦æ•°ã€ä»˜è´¹å­—ç¬¦æ•°ã€æ‰£é™¤ç§¯åˆ†ã€å‰©ä½™å…è´¹é¢åº¦ç­‰ï¼‰
-- è¿”å›æ ¼å¼ï¼š
--   {
--     success: boolean,
--     free_characters_used: integer,
--     paid_characters: integer,
--     credits_deducted: integer,
--     remaining_free: integer,
--     total_used_today: integer
--   }
--   æˆ–é”™è¯¯ï¼š
--   {
--     success: false,
--     error: 'INSUFFICIENT_CREDITS',
--     message: string,
--     required_credits: integer,
--     available_credits: integer
--   }
```

## Webhook å¹‚ç­‰ä¸è®¢å•æ˜ å°„
- å¹‚ç­‰é”ï¼šä¼˜å…ˆæ’å…¥ payments(unique_key = event.id) ä½œä¸ºâ€œé¢„å ä½â€ã€‚è‹¥å”¯ä¸€é”®å†²çªåˆ™ç›´æ¥è¿”å› 200ï¼Œä¸å†åŠ åˆ†ã€‚
- æ¬¡çº§å¹‚ç­‰ï¼šè‹¥ `orders.creem_session_id = checkout.id` å·²å­˜åœ¨ï¼Œåˆ™ä»…æ›´æ–°æ—¢æœ‰ payments çš„ `order_id/payload_json`ï¼Œä¸é‡å¤è®¡è´¹ã€‚
- äº§å“æ˜ å°„ï¼šç”¨ `checkout.order.product` æˆ– `checkout.product.id` åŒ¹é… `products.creem_product_id`ï¼Œå¾—åˆ°æœ¬åœ° `products.id` ä½œä¸º `orders.product_id`ã€‚