---
alwaysApply: true
---

## Supabase ç”¨æ³•
- ä»…é€šè¿‡ `@/lib/supabase` æš´éœ²çš„ helper ä½¿ç”¨ï¼š
  - `getSupabaseClient()` ç”¨äº Client ç»„ä»¶ã€‚
  - `getServerSupabase()`ï¼ˆæˆ– server action å†…ï¼‰ç”¨äºæœåŠ¡ç«¯ã€‚
- æ‰€æœ‰æŸ¥è¯¢é»˜è®¤ **RLS å¼€å¯**ï¼›æœåŠ¡ç«¯éœ€è¦æ›´é«˜æƒé™æ—¶ï¼Œä½¿ç”¨**æœåŠ¡ç«¯å¯†é’¥**äº Route Handlerï¼ˆä¸å¯åœ¨å®¢æˆ·ç«¯æš´éœ²ï¼‰ã€‚

## API & Route Handlers
- API è·¯ç”±æ”¾ /app/api/**ï¼Œé»˜è®¤ Edge ä»…å½“æ—  Node ä¾èµ–ã€‚
- æ ¡éªŒï¼šZodï¼ˆæˆ–æœ€å°æ‰‹å†™æ ¡éªŒï¼‰ï¼›è¿”å›æ˜ç¡®çš„é”™è¯¯ç»“æ„ `{ ok:false, code, message }`ã€‚
- ç¦æ­¢åœ¨ API ä¸­åš SSR-only ä»»åŠ¡ä¸é‡é‡çº§é˜»å¡ï¼ˆäº¤ç»™é˜Ÿåˆ—/edge/cronï¼‰ã€‚

## å®‰å…¨
- ç¦æ­¢æŠŠ `SERVICE_ROLE` æ”¾åˆ°ä»»ä½•å®¢æˆ·ç«¯å¯è¾¾ä»£ç /ç¯å¢ƒå˜é‡ã€‚
- å¯¹å¤–è¿”å›æ•°æ®**æŒ‰éœ€**é€‰æ‹©å­—æ®µï¼›æ°¸è¿œä¸è¦ `select *` æš´éœ²æ•æ„Ÿåˆ—ã€‚
- é™æµï¼šå¦‚æœ‰å¤–éƒ¨å¯è°ƒç”¨æ¥å£ï¼Œè‡³å°‘æŒ‰ IP/ä¼šè¯åšç®€å•é™æµã€‚

## æ•°æ®åº“è¡¨ç»“æ„

âš ï¸ **é‡è¦ç»´æŠ¤æé†’**ï¼š
- ğŸ”´ å½“æ•°æ®åº“æœ‰ä»»ä½•æ”¹åŠ¨æ—¶ï¼Œå¿…é¡»ç«‹å³æ›´æ–°æ­¤æ–‡ä»¶
- ğŸ”´ ä¿æŒæ­¤è¡¨ç»“æ„ä¸å®é™…æ•°æ®åº“åŒæ­¥æ˜¯å¼ºåˆ¶è¦æ±‚
- ğŸ”´ æ–°å¢è¡¨ã€ä¿®æ”¹å­—æ®µã€æ·»åŠ çº¦æŸæ—¶ï¼Œæ·»åŠ ç›¸åº”çš„è¯´æ˜æ³¨é‡Š

### ğŸ“Š å½“å‰è¡¨ç»“æ„ (2025-01-27)

#### ğŸ‘¤ user_info è¡¨
```sql
- user_id (uuid, ä¸»é”®) â†’ å…³è” auth.users.id
- credits (bigint, é»˜è®¤: 0) â†’ ç”¨æˆ·ç§¯åˆ†
- created_at (timestamptz, é»˜è®¤: now())
- updated_at (timestamptz, é»˜è®¤: now())
```
**ç”¨é€”**: å­˜å‚¨ç”¨æˆ·ç§¯åˆ†ä¿¡æ¯
**RLS**: âœ… å¯ç”¨

#### ğŸ›ï¸ products è¡¨
```sql
- id (uuid, ä¸»é”®, é»˜è®¤: uuid_generate_v4())
- title (text) â†’ äº§å“æ ‡é¢˜
- credits (integer, çº¦æŸ: > 0) â†’ ç§¯åˆ†æ•°é‡
- price_usd (numeric, çº¦æŸ: >= 0) â†’ ç¾å…ƒä»·æ ¼
- creem_product_id (text, å”¯ä¸€) â†’ Creemæ”¯ä»˜äº§å“ID
- type (product_typeæšä¸¾, é»˜è®¤: 'one_time') â†’ äº§å“ç±»å‹
  - æšä¸¾å€¼: 'one_time', 'subscription'
- currency (text, é»˜è®¤: 'USD') â†’ è´§å¸
- active (boolean, é»˜è®¤: true) â†’ æ˜¯å¦æ¿€æ´»
- created_at (timestamptz, é»˜è®¤: now())
```
**ç”¨é€”**: å­˜å‚¨äº§å“/å¥—é¤ä¿¡æ¯
**RLS**: âœ… å¯ç”¨

#### ğŸ’° credit_ledger è¡¨
```sql
- id (uuid, ä¸»é”®, é»˜è®¤: uuid_generate_v4())
- user_id (uuid) â†’ å…³è” auth.users.id
- delta (bigint) â†’ ç§¯åˆ†å˜åŠ¨é‡ï¼ˆæ­£æ•°å¢åŠ ï¼Œè´Ÿæ•°å‡å°‘ï¼‰
- note (text, å¯ç©º) â†’ å˜åŠ¨è¯´æ˜
- created_at (timestamptz, é»˜è®¤: now())
```
**ç”¨é€”**: ç§¯åˆ†å˜åŠ¨è®°å½•ï¼ˆå®¡è®¡æ—¥å¿—ï¼‰
**RLS**: âœ… å¯ç”¨

#### ğŸ“¦ orders è¡¨
```sql
- id (uuid, ä¸»é”®, é»˜è®¤: uuid_generate_v4())
- user_id (uuid) â†’ å…³è” auth.users.id
- product_id (uuid) â†’ å…³è” products.id
- units (integer, é»˜è®¤: 1, çº¦æŸ: > 0) â†’ è´­ä¹°æ•°é‡
- status (order_statusæšä¸¾, é»˜è®¤: 'pending') â†’ è®¢å•çŠ¶æ€
  - æšä¸¾å€¼: 'pending', 'paid', 'refunded', 'canceled'
- request_id (text) â†’ è¯·æ±‚ID
- creem_session_id (text, å¯ç©º) â†’ Creemä¼šè¯ID
- creem_order_id (text, å¯ç©º) â†’ Creemè®¢å•ID
- amount_total_cents (integer, å¯ç©º) â†’ æ€»é‡‘é¢ï¼ˆåˆ†ï¼‰
- currency (text, å¯ç©º, é»˜è®¤: 'USD') â†’ è´§å¸
- created_at (timestamptz, é»˜è®¤: now())
- paid_at (timestamptz, å¯ç©º) â†’ æ”¯ä»˜æ—¶é—´
```
**ç”¨é€”**: è®¢å•ç®¡ç†
**RLS**: âœ… å¯ç”¨

#### ğŸ’³ payments è¡¨
```sql
- id (uuid, ä¸»é”®, é»˜è®¤: uuid_generate_v4())
- order_id (uuid, å¯ç©º) â†’ å…³è” orders.id
- provider (text, é»˜è®¤: 'creem') â†’ æ”¯ä»˜æä¾›å•†
- event_type (text) â†’ äº‹ä»¶ç±»å‹
- unique_key (text) â†’ å”¯ä¸€æ ‡è¯†
- payload_json (jsonb) â†’ æ”¯ä»˜æ•°æ®ï¼ˆJSONæ ¼å¼ï¼‰
- created_at (timestamptz, é»˜è®¤: now())
```
**ç”¨é€”**: æ”¯ä»˜äº‹ä»¶è®°å½•
**RLS**: âœ… å¯ç”¨

### ğŸ”— è¡¨å…³ç³»å›¾
```
auth.users (Supabase Auth)
    â†“
user_info (ç”¨æˆ·ç§¯åˆ†)
    â†“
credit_ledger (ç§¯åˆ†å˜åŠ¨è®°å½•)

products (äº§å“è¡¨)
    â†“
orders (è®¢å•è¡¨) â†’ payments (æ”¯ä»˜è®°å½•)
```

### ğŸ“ˆ æ•°æ®ç»Ÿè®¡
- **æ€»è¡¨æ•°**: 5ä¸ª
- **æœ‰æ•°æ®çš„è¡¨**: products (3è¡Œ)
- **ç©ºè¡¨**: user_info, credit_ledger, orders, payments
- **RLSçŠ¶æ€**: å…¨éƒ¨å¯ç”¨ âœ…